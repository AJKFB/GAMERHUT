<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

  <meta charset="UTF-8">
  <title>لوحة تحكم المشرف</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: 'Segoe UI', Tahoma, sans-serif;
      background-color: #1e1e2f;
      color: #fff;
      direction: rtl;
    }

    .toggle-btn {
      display: none;
      position: fixed;
      top: 15px;
      right: 15px;
      background-color: #4fc3f7;
      border: none;
      padding: 10px 15px;
      font-size: 20px;
      border-radius: 5px;
      z-index: 1001;
      cursor: pointer;
    }

    .sidebar {
      width: 250px;
      background-color: #111;
      height: 100vh;
      padding-top: 20px;
      position: fixed;
      right: 0;
      top: 0;
      transition: right 0.3s;
      z-index: 1000;
    }

    .sidebar h2 {
      text-align: center;
      margin-bottom: 30px;
      color: #4fc3f7;
    }

    .sidebar a {
      display: block;
      padding: 15px 20px;
      color: white;
      text-decoration: none;
      transition: 0.3s;
    }

    .sidebar a:hover {
      background-color: #333;
      padding-right: 30px;
    }

    .main-content {
      margin-right: 250px;
      padding: 40px;
      transition: margin 0.3s;
    }

    h1 {
      margin-bottom: 20px;
      color: #4fc3f7;
    }

    .card {
      background-color: #2a2a3d;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      margin-bottom: 20px;
    }

    /* ✅ تنسيق الهاتف */
    @media (max-width: 768px) {
      .toggle-btn {
        display: block;
      }

      .sidebar {
        right: -250px;
      }

      .sidebar.active {
        right: 0;
      }

      .main-content {
        margin-right: 0;
        padding: 20px;
      }

      .main-content.blur {
        filter: blur(2px);
      }
    }

    h3 {
      margin-bottom: 20px;
      color: #ffffff;
    }




    .settings-section {
  display: flex;
  flex-direction: column;
  gap: 30px;
}

.card {
  background-color: #2a2a3d;
  padding: 20px;
  border-radius: 12px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.3);
}

.card h3 {
  margin-bottom: 15px;
  color: #4fc3f7;
}

.card form input,
.card form select,
.card form textarea,
.card form button {
  width: 100%;
  max-width: 100%;
  margin-bottom: 10px;
  padding: 10px;
  border: none;
  border-radius: 8px;
  font-family: inherit;
}

.card form button {
  background-color: #4fc3f7;
  color: black;
  font-weight: bold;
  cursor: pointer;
  transition: background 0.2s;
}

.card form button:hover {
  background-color: #38b6ff;
}

/* ⚠️ تخصيص الجدول */
.card table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 10px;
}

.card table th,
.card table td {
  padding: 10px;
  text-align: center;
}

.card table th {
  background: #333;
  color: white;
}

.card table td {
  background: #2a2a3d;
  color: #ccc;
}

/* ✅ استجابة الهاتف */
@media (max-width: 768px) {
  .settings-section {
    padding: 10px;
  }

  .card {
    padding: 15px;
  }

  .card form input,
  .card form select,
  .card form textarea,
  .card form button {
    font-size: 14px;
  }

  .card table th,
  .card table td {
    font-size: 13px;
    padding: 8px;
  }
}
  </style>
</head>
<body>

  <!-- زر القائمة للجوال -->
  <button class="toggle-btn" onclick="toggleSidebar()">☰</button>

  <!-- القائمة الجانبية -->
  <div class="sidebar" id="sidebar">
    <h2>📊 لوحة التحكم</h2>
    <a href="#" onclick="showSection('section-home')">🏠 الرئيسية</a>
    <a href="#" onclick="showSection('section-orders')">📦 الطلبات</a>
    <a href="#" onclick="showSection('section-keys')">🧾 رموز التفعيل</a>
    <a href="#" onclick="showSection('section-users')">👤 المستخدمون</a>
    <a href="#" onclick="showSection('section-stats')">📈 الإحصائيات</a>
    <a href="#" onclick="showSection('section-Settings')">⚙️ إعدادات الموقع العامة</a>
    <a href="#" onclick="showSection('section-logout')">🔐 تسجيل الخروج</a>
  </div>

  <div class="main-content">
    <h1>مرحبًا أيها المشرف</h1>

    <!-- ✅ القسم الرئيسي ظاهر -->
    <div id="section-home" class="admin-section">
      <div class="card">
        <p>هذه هي لوحة تحكم المشرف. يمكنك التنقل من القائمة الجانبية.</p>
      </div>
    </div>

    <!-- ✅ الأقسام الأخرى مخفية -->
    <div id="section-orders" class="admin-section" style="display: none;">
  <h2>📦 الطلبات</h2>
  <table style="width:100%; border-collapse: collapse; margin-top: 20px;">
    <thead>
      <tr style="background-color: #333; color: #fff;">
        <th style="padding: 10px;">رقم الطلب</th>
        <th>البريد الإلكتروني</th>
        <th>الحالة</th>
        <th>تاريخ الإنشاء</th>
        <th>الإجراء</th>
      </tr>
    </thead>
    <tbody>
      {% for order in orders %}
      <tr style="background:#2a2a3d; color:#eee; border-bottom:1px solid #444;">
        <td style="padding:10px;">{{ order.order_id }}</td>
        <td>{{ order.email }}</td>
        <td>
          {% if order.status == 'pending' %}
            ⏳ بانتظار
          {% elif order.status == 'verified' %}
            ✅ تم التأكيد
          {% elif order.status == 'rejected' %}
            ❌ مرفوض
          {% endif %}
        </td>
        <td>{{ order.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
        <td>
          {% if order.status == 'verified' %}
            ✅ تم الموافقة
          {% elif order.status == 'rejected' %}
            ❌ تم الرفض
          {% else %}
            ⏳ لم يتم اتخاذ إجراء بعد
          {% endif %}
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<div id="section-keys" class="admin-section" style="display: none;">
  <h2>🧾 رموز التفعيل</h2>

{% for product, keys in keys_by_product.items() %}
  <div class="card" style="margin-bottom: 30px;">
    <h3>🎮 {{ product }}</h3>
    <p>📦 الأكواد المتوفرة: {{ keys | selectattr('status', 'equalto', 'available') | list | length }} / {{ keys | length }}</p>
    <details>
      <summary style="cursor: pointer;">عرض الأكواد</summary>
      <table style="width:100%; margin-top:10px; border-collapse:collapse;">
        <thead>
          <tr style="background:#333; color:#fff;">
            <th>رمز التفعيل</th>
            <th>الحالة</th>
            <th>تاريخ الإضافة</th>
            <th>إجراءات</th>
          </tr>
        </thead>
        <tbody>
          {% for code in keys %}
          <tr style="background:#2a2a3d; color:#eee;">
            <td style="padding:8px;">{{ code.key_code }}</td>
            <td style="color: {{ 'lightgreen' if code.status == 'available' else 'red' }};">
              {{ '✅ متوفر' if code.status == 'available' else '❌ تم بيعه' }}
            </td>
            <td>{{ code.created_at }}</td>
            <td>
              <!-- زر الحذف -->
              <form method="POST" action="/delete_code" style="display:inline;">
                <input type="hidden" name="key_code" value="{{ code.key_code }}">
                <button type="submit" style="background:red;color:white;border:none;padding:4px 8px;border-radius:5px;">🗑️</button>
              </form>

              <!-- زر التعديل -->
              <form method="POST" action="/edit_code" style="display:inline;">
                <input type="hidden" name="key_code" value="{{ code.key_code }}">
                <input type="text" name="new_product_name" placeholder="تعديل الاسم" required style="padding:4px;border-radius:5px;width:120px;">
                <button type="submit" style="background:orange;color:white;border:none;padding:4px 8px;border-radius:5px;">✏️</button>
              </form>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </details>
  </div>
{% endfor %}




<!-- 🔘 زر فتح/إغلاق النموذج -->
<h3 style="margin-top: 30px;">
  <span onclick="toggleForm()" style="cursor:pointer; color:#fff;">
    <b style="font-size: 24px; color:#4fc3f7;">➕</b> إضافة رمز تفعيل جديد
  </span>
</h3>

<!-- ✅ النموذج نفسه -->
<div id="add-key-form" style="display: none;">
  <form method="POST" action="/add_code" style="background:#2a2a3d;padding:20px;border-radius:10px;width:100%;max-width:600px;">
    <label for="product_name">🕹️ اسم المنتج:</label><br>
    <input type="text" name="product_name" required style="width:100%;padding:10px;border:none;border-radius:6px;margin-bottom:15px;"><br>

    <label for="key_code">🔑 رمز التفعيل:</label><br>
    <textarea name="key_code" required style="width:100%;height:80px;padding:10px;border:none;border-radius:6px;margin-bottom:15px;"></textarea><br>

    <label for="status">⚙️ الحالة:</label><br>
    <select name="status" style="width:100%;padding:10px;border-radius:6px;margin-bottom:15px;">
      <option value="available">✅ متوفر</option>
      <option value="sold">❌ تم بيعه</option>
    </select><br>

    <label>📅 تاريخ الإضافة:</label><br>
    <input type="text" value="{{ now.strftime('%Y-%m-%d %H:%M') }}" disabled style="width:100%;padding:10px;border:none;border-radius:6px;background:#444;color:#ccc;"><br><br>

    <button type="submit" style="background:#4fc3f7;color:#000;padding:10px 20px;border:none;border-radius:8px;cursor:pointer;">📥 إضافة الرمز</button>
  </form>
</div>

<hr>

<!-- العنوان القابل للنقر -->
<h3 style="margin-top: 30px; cursor: pointer;" onclick="toggleSendForm()">
  📤 إرسال كود تفعيل للعميل <span id="arrow">⬇️</span>
</h3>

<!-- النموذج داخل div مخفي -->
<div id="send-key-form" style="display: none;">
  <form method="POST" action="/send_key" style="background:#2a2a3d;padding:20px;border-radius:10px;width:100%;max-width:600px;">
    
    <label>📧 بريد العميل:</label>
    <input type="email" name="email" required style="width:100%;padding:10px;margin-bottom:15px;"><br>

    <label>🧾 رمز الطلب:</label>
    <input type="text" name="order_id" required style="width:100%;padding:10px;margin-bottom:15px;"><br>

    <label>🕹️ اسم المنتج:</label>
    <select name="product_name" id="product-select" required style="width:100%;padding:10px;margin-bottom:15px;">
      {% for product in keys_by_product.keys() %}
        <option value="{{ product }}">{{ product }}</option>
      {% endfor %}
    </select><br>

    <label>🔑 رمز التفعيل:</label>
    <select name="activation_code" id="code-select" required style="width:100%;padding:10px;margin-bottom:15px;">
      <!-- يتم ملؤه تلقائيًا بجافاسكربت -->
    </select><br>

    <label>📎 مرفق (اختياري):</label>
    <textarea name="note" placeholder="رابط شرح أو ملاحظات" style="width:100%;height:80px;padding:10px;"></textarea><br>

    <button type="submit" style="background:#4fc3f7;color:#000;padding:10px 20px;border:none;border-radius:8px;cursor:pointer;">📩 إرسال الكود</button>
  </form>
</div>

<!-- JavaScript -->
<script>
  function toggleSendForm() {
    const form = document.getElementById("send-key-form");
    const arrow = document.getElementById("arrow");
    const isHidden = form.style.display === "none";

    form.style.display = isHidden ? "block" : "none";
    arrow.textContent = isHidden ? "⬆️" : "⬇️";
  }
</script>
</div>


<div id="section-users" class="admin-section" style="display: none;">
  <h2>👤 المستخدمون</h2>
  <table style="width:100%; border-collapse: collapse; margin-top: 20px;">
    <thead>
      <tr style="background-color: #333; color: #fff;">
        <th>الاسم الكامل</th>
        <th>البريد الإلكتروني</th>
        <th>اسم المستخدم</th>
        <th>تم التوثيق</th>
        <th>تاريخ التسجيل</th>
        <th>الحالة</th>
        <th>إجراء</th>
      </tr>
    </thead>
    <tbody>
      {% for user in users %}
      <tr style="background:#2a2a3d; color:#eee; border-bottom:1px solid #444;">
        <td>{{ user.full_name }}</td>
        <td>{{ user.email }}</td>
        <td>{{ user.username or '—' }}</td>
        <td>{{ '✅' if user.is_verified else '❌' }}</td>
        <td>
          {% if user.registered_at %}
            {{ user.registered_at.strftime('%Y-%m-%d %H:%M') }}
          {% else %}
            غير متوفر
          {% endif %}
        </td>
        <td>
          {% if user.is_banned %}
            🚫 محظور
          {% elif user.ban_until and user.ban_until > now %}
            ⏳ حظر مؤقت
          {% else %}
            ✅ نشط
          {% endif %}
        </td>
        <td>
          {% if user.is_banned %}
            <form method="POST" action="/unban_user">
              <input type="hidden" name="user_id" value="{{ user.id }}">
              <button type="submit">🔓 إلغاء الحظر</button>
            </form>
          {% else %}
            <form method="POST" action="/ban_user">
              <input type="hidden" name="user_id" value="{{ user.id }}">
              <select name="ban_duration">
                <option value="permanent">دائم</option>
                <option value="7">7 أيام</option>
                <option value="30">30 يومًا</option>
              </select>
              <button type="submit">🚫 حظر</button>
            </form>
          {% endif %}
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<div id="section-stats" class="admin-section" style="display: none;">
  <h2>📊 لوحة الإحصائيات</h2>
  <div class="stats-container">

    <div class="stat-card">
      <h3 onclick="toggleChart('dailyChart')">📅 عدد الزوار اليومي</h3>
      <div id="dailyChart" style="display: none;">
        <canvas id="dailyVisitsCanvas"></canvas>
      </div>
    </div>

    <div class="stat-card">
      <h3 onclick="toggleChart('weeklyChart')">📆 عدد الزوار الأسبوعي</h3>
      <div id="weeklyChart" style="display: none;">
        <canvas id="weeklyVisitsCanvas"></canvas>
      </div>
    </div>

    <div class="stat-card">
      <h3 onclick="toggleChart('hourlyChartWrap')">⏰ عدد الزوار حسب الساعات (اليوم)</h3>
      <div id="hourlyChartWrap" style="display: none;">
        <canvas id="hourlyVisitsChart"></canvas>
      </div>
    </div>

    <div class="stat-card">
      <h3 onclick="toggleChart('monthlyChart')">🗓️ عدد الزوار الشهري</h3>
      <div id="monthlyChart" style="display: none;">
        <canvas id="monthlyVisitsCanvas"></canvas>
      </div>
    </div>

    <div class="stat-card">
      <h3 onclick="toggleChart('topProductsChartWrap')">🔥 المنتجات الأكثر مبيعًا</h3>
      <div id="topProductsChartWrap" style="display: none;">
        <canvas id="topProductsChart"></canvas>
      </div>
    </div>

    <div class="stat-card">
      <h3 onclick="toggleChart('keysStatusChartWrap')">🔑 الأكواد المتوفرة مقابل المباعة</h3>
      <div id="keysStatusChartWrap" style="display: none;">
        <canvas id="keysStatusChart"></canvas>
      </div>
    </div>

    <div class="stat-card">
      <h3 onclick="toggleChart('cartAdditionsChartWrap')">🛒 المنتجات الأكثر إضافة للسلة</h3>
      <div id="cartAdditionsChartWrap" style="display: none;">
        <canvas id="cartAdditionsChart"></canvas>
      </div>
    </div>

    <div class="stat-card">
      <h3>👥 عدد المستخدمين الموثقين</h3>
      <p style="font-size: 32px; text-align: center; margin-top: 20px; color: #4fc3f7;">
        {{ verified_users_count }}
      </p>
    </div>

  </div>
</div>




<div id="section-Settings" class="admin-section" style="display: none;">
  <h2>⚙️ إعدادات الموقع العامة</h2>

  <div class="settings-section">

    <!-- 🔌 حالة الموقع -->
    <div class="card">
      <h3>🔌 حالة الموقع</h3>
      <form method="POST" action="/toggle_site_status" onsubmit="return confirmAction();">
        <p>الوضع الحالي:
          <span style="color: {{ 'lightgreen' if site_settings.site_enabled else 'red' }};">
            {{ '✅ مفعل' if site_settings.site_enabled else '❌ متوقف' }}
          </span>
        </p>

        <input type="hidden" name="new_status" id="new_status_input" value="{{ 'false' if site_settings.site_enabled else 'true' }}">

        {% if site_settings.site_enabled %}
        <label>📋 اختر سبب الإغلاق:</label>
        <select name="selected_reason" id="reason-select" onchange="toggleCustomReason()" required>
          <option value="maintenance">🛠️ صيانة دورية</option>
          <option value="weekend">🛌 عطلة نهاية الأسبوع</option>
          <option value="update">🔄 تحديثات تقنية</option>
          <option value="security">🔐 فحص أمني</option>
          <option value="custom">✍️ سبب مخصص</option>
        </select>

        <div id="custom-reason-box" style="display:none;">
          <label>✍️ اكتب سببك المخصص:</label>
          <textarea name="custom_reason" rows="3"></textarea>
        </div>
        {% endif %}

        <button type="submit">
          {{ '⛔️ إيقاف الموقع مؤقتًا' if site_settings.site_enabled else '✅ إعادة تشغيل الموقع' }}
        </button>
      </form>
    </div>

    <!-- 💱 سعر الدولار -->
    <div class="card">
      <h3>💱 سعر الدولار إلى الدينار</h3>
      <form method="POST" action="/admin/update_currency">
        <label>1 دولار =</label>
        <input type="number" name="usd_to_dzd" value="{{ config.usd_to_dzd }}" required min="1" step="1">
        <span>دينار جزائري</span>
        <button type="submit">💾 تحديث السعر</button>
      </form>
    </div>

<!-- 🎯 إدارة العروض -->
<div class="card">
  <h3>🎯 إدارة العروض المباشرة</h3>
  <form method="POST" action="/admin/add_offer">
    <!-- 🔑 كود المنتج -->
    <label>🧩 كود المنتج:</label>
    <input type="text" name="product_code" placeholder="مثل: GOW أو FIFA24" required>

    <!-- 📉 نسبة الخصم -->
    <label>📉 نسبة الخصم (%):</label>
    <input type="number" name="discount" min="1" max="100" required>

    <!-- 📣 نص تسويقي (اختياري) -->
    <label>📣 نص ترويجي (اختياري):</label>
    <input type="text" name="highlight_text" placeholder="مثال: عرض خاص لفترة محدودة 🎁">

    <!-- 📅 التاريخ -->
    <label>📅 يبدأ من:</label>
    <input type="date" name="start_date" required>

    <label>📅 ينتهي في:</label>
    <input type="date" name="end_date" required>

    <button type="submit">➕ إضافة عرض</button>
  </form>
</div>

<!-- 📋 جدول العروض الخاصة -->
<div class="card" style="margin-top: 30px;">
  <h4>📋 العروض الخاصة على المنتجات:</h4>
  <table border="1" style="width: 100%; text-align: center;">
    <thead>
      <tr>
        <th>📦 المنتج</th>
        <th>📉 الخصم</th>
        <th>📅 من</th>
        <th>📅 إلى</th>
        <th>📢 ترويج</th>
        <th>🔖 النوع</th>
        <th>🗑️ حذف</th>
      </tr>
    </thead>
    <tbody>
      {% for offer in offers %}
        {% if offer.product %}
        <tr>
          <td>{{ offer.product.name }}</td>
          <td>{{ offer.discount }}%</td>
          <td>{{ offer.start_date.strftime('%Y-%m-%d') }}</td>
          <td>{{ offer.end_date.strftime('%Y-%m-%d') }}</td>
          <td>{{ offer.highlight_text or "—" }}</td>
          <td>عرض خاص</td>
          <td>
            <form method="POST" action="/admin/delete_offer">
              <input type="hidden" name="offer_id" value="{{ offer.id }}">
              <button type="submit">🗑️</button>
            </form>
          </td>
        </tr>
        {% endif %}
      {% endfor %}
    </tbody>
  </table>
</div>



    <!-- 🎟️ كوبونات الخصم -->
    <div class="card">
      <h3>🎟️ كوبونات الخصم</h3>
      <form method="POST" action="/admin/add_coupon">
        <label>🔖 رمز الكوبون:</label>
        <input name="code" placeholder="مثال: SALE20" required>

        <label>💲 قيمة الخصم:</label>
        <input name="discount_value" type="number" placeholder="مثال: 20" required>

        <label>📌 نوع الخصم:</label>
        <select name="discount_type">
          <option value="percent">نسبة مئوية %</option>
          <option value="fixed">مبلغ ثابت 💵</option>
        </select>

        <label>📅 تاريخ الانتهاء:</label>
        <input name="expires_at" type="date">

        <label>🛒 المنتجات المسموحة:</label>
        <input name="restricted_products" placeholder='مثال: ["GTA", "MC", "FIFA"]'>

        <button type="submit">➕ إنشاء كوبون</button>
      </form>

<h4 style="margin-top: 20px;">📋 العروض الحالية:</h4>
<table>
  <tr>
    <th>المنتج</th>
    <th>الخصم</th>
    <th>من</th>
    <th>إلى</th>
    <th>🗑️</th>
  </tr>
  {% for offer in offers %}
  <tr>
    <td>{{ offer.product_code }}</td>
    <td>{{ offer.discount }}%</td>
    <td>{{ offer.start_date }}</td>
    <td>{{ offer.end_date }}</td>
    <td>
      <form method="POST" action="/admin/delete_offer" onsubmit="return confirm('هل تريد حذف العرض؟')">
        <input type="hidden" name="offer_id" value="{{ offer.id }}">
        <button type="submit">🗑️ حذف</button>
      </form>
    </td>
  </tr>
  {% endfor %}
</table>


    <!-- ➕ إضافة منتج للواجهة -->
    <div class="card">
      <h3>🕹️ إضافة منتج للواجهة</h3>
      <form method="POST" action="/admin/add_home_product" enctype="multipart/form-data">
        <label>اسم المنتج:</label>
        <input type="text" name="product_name" required>

        <label>صورة المنتج:</label>
        <input type="file" name="image_file" accept="image/*" required>

        <label>وصف مختصر:</label>
        <input type="text" name="description" required>

        <label>السعر بالدولار:</label>
        <input type="number" name="usd_price" required min="1">

        <button type="submit">➕ إضافة</button>
      </form>
    </div>

    <!-- 🛠️ تعديل المنتجات -->
    <div class="card">
      <h3>🛠️ تعديل المنتجات الحالية</h3>
      {% for product in products_list %}
      <form method="POST" action="/admin/update_product/{{ loop.index0 }}">
        <textarea name="product_html" rows="7">{{ product.strip() }}</textarea>
        <button type="submit">💾 حفظ</button>
        <a href="/admin/delete_product/{{ loop.index0 }}">🗑️ حذف</a>
        <hr>
      </form>
      {% endfor %}
    </div>

    <!-- 📂 تعديل JSON -->
    <div class="card">
      <h3>📂 تعديل ملف تفاصيل المنتجات</h3>
      <form method="POST" action="/admin/edit_products_json">
        <textarea name="json_content" rows="10" style="font-family: monospace;">{{ products_json }}</textarea>
        <button type="submit">💾 حفظ التعديلات</button>
      </form>
    </div>

   <div class="card">
  <h3>📢 إضافة إشعار عام</h3>
  <form method="POST" action="/admin/add_notice">
    <label>📝 نص الإشعار:</label>
    <textarea name="text" required></textarea>

    <label>🎨 اللون (Hex أو اسم):</label>
    <input type="text" name="color" placeholder="#ff0000 أو red" required>

    <label>🔖 نوع الإشعار:</label>
    <select name="type" required>
      <option value="info">معلومة</option>
      <option value="warning">تحذير</option>
      <option value="success">نجاح</option>
      <option value="danger">خطير</option>
    </select>

    <button type="submit">➕ إضافة الإشعار</button>
  </form>
</div>
<div class="card" style="margin-top: 20px;">
  <h4>🗂️ جميع الإشعارات</h4>
  <table border="1" style="width: 100%; text-align: center;">
    <tr>
      <th>النص</th>
      <th>النوع</th>
      <th>اللون</th>
      <th>نشط؟</th>
      <th>حذف</th>
    </tr>
    {% for notice in notices %}
    <tr>
      <td>{{ notice.text }}</td>
      <td>{{ notice.type }}</td>
      <td><span style="background-color: {{ notice.color }}; padding: 3px 10px;">{{ notice.color }}</span></td>
      <td>{{ "✅" if notice.is_active else "❌" }}</td>
      <td>
        <form method="POST" action="/admin/delete_notice">
          <input type="hidden" name="notice_id" value="{{ notice.id }}">
          <button type="submit">🗑️</button>
        </form>
      </td>
    </tr>
    {% endfor %}
  </table>
</div>


<script>
  function toggleCustomReason() {
    const select = document.getElementById("reason-select");
    const customBox = document.getElementById("custom-reason-box");
    customBox.style.display = select.value === "custom" ? "block" : "none";
  }

  function confirmAction() {
    const status = "{{ site_settings.site_enabled }}";
    if (status === "True" || status === "true") {
      return confirm("⚠️ هل أنت متأكد من إيقاف الموقع؟");
    }
    return true;
  }
</script>



<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>





<script>
// 📅 الزوار اليومي
new Chart(document.getElementById('dailyVisitsCanvas'), {
  type: 'line',
  data: {
    labels: {{ daily_labels | tojson }},
    datasets: [{
      label: 'عدد الزوار',
      data: {{ daily_counts | tojson }},
      borderColor: '#42a5f5',
      backgroundColor: 'rgba(66, 165, 245, 0.2)',
      fill: true,
      tension: 0.4,
      pointRadius: 0,
      borderWidth: 2
    }]
  },
  options: {
    responsive: true,
    scales: {
      x: {
        title: {
          display: true,
          text: 'اليوم',
          color: '#fff'
        },
        ticks: {
          color: '#ccc'
        },
        grid: {
          color: '#333'
        }
      },
      y: {
        beginAtZero: true,
        ticks: {
          stepSize: 1,
          precision: 0,
          color: '#ccc'
        },
        title: {
          display: true,
          text: 'عدد الزوار',
          color: '#fff'
        },
        grid: {
          color: '#333'
        }
      }
    },
    plugins: {
      legend: { labels: { color: '#fff' } },
      tooltip: {
        backgroundColor: '#333',
        titleColor: '#fff',
        bodyColor: '#fff'
      }
    }
  }
});

new Chart(document.getElementById('weeklyVisitsCanvas'), {
  type: 'line',
  data: {
    labels: {{ weekly_labels|tojson }},
    datasets: [{
      label: 'عدد الزوار',
      data: {{ weekly_counts|tojson }},
      borderColor: '#81c784',
      fill: false
    }]
  }
});

new Chart(document.getElementById('monthlyVisitsCanvas'), {
  type: 'line',
  data: {
    labels: {{ monthly_labels|tojson }},
    datasets: [{
      label: 'عدد الزوار',
      data: {{ monthly_counts|tojson }},
      borderColor: '#ffb74d',
      fill: false
    }]
  }
});

new Chart(document.getElementById('topProductsChart'), {
  type: 'bar',
  data: {
    labels: {{ top_product_names|tojson }},
    datasets: [{
      label: 'عدد الطلبات',
      data: {{ top_product_counts|tojson }},
      backgroundColor: ['#81c784', '#ffb74d', '#e57373', '#64b5f6', '#ba68c8']
    }]
  }
});

new Chart(document.getElementById('keysStatusChart'), {
  type: 'pie',
  data: {
    labels: ['متوفرة', 'مباعة'],
    datasets: [{
      data: [{{ available_count }}, {{ sold_count }}],
      backgroundColor: ['#4fc3f7', '#ef5350']
    }]
  }
});

new Chart(document.getElementById('cartAdditionsChart'), {
  type: 'doughnut',
  data: {
    labels: {{ cart_product_names|tojson }},
    datasets: [{
      data: {{ cart_product_counts|tojson }},
      backgroundColor: ['#ffd54f', '#4db6ac', '#9575cd', '#ff8a65', '#90caf9']
    }]
  }
});
</script>



<script>
const hourlyCtx = document.getElementById('hourlyVisitsChart').getContext('2d');
const hourlyVisitsChart = new Chart(hourlyCtx, {
  type: 'line',
  data: {
    labels: {{ hourly_labels | tojson }},
    datasets: [{
      label: 'عدد الزوار في كل ساعة',
      data: {{ hourly_counts | tojson }},
      backgroundColor: 'rgba(33, 150, 243, 0.2)',
      borderColor: 'rgba(33, 150, 243, 1)',
      borderWidth: 2,
      pointRadius: 3,
      tension: 0.3,
      fill: true
    }]
  },
  options: {
    responsive: true,
    scales: {
      y: {
        beginAtZero: true,
        ticks: {
          stepSize: 1
        }
      }
    },
    plugins: {
      legend: {
        labels: { color: 'white' }
      }
    }
  }
});
</script>





<script>
  const allKeys = JSON.parse('{{ keys_by_product | tojson | safe }}');
  const productSelect = document.getElementById("product-select");
  const codeSelect = document.getElementById("code-select");

  function updateCodes() {
    const selectedProduct = productSelect.value;
    const keys = allKeys[selectedProduct] || [];

    codeSelect.innerHTML = "";

    keys.forEach(key => {
      if (key.status === "available") {
        const option = document.createElement("option");
        option.value = key.key_code;
        option.textContent = key.key_code;
        codeSelect.appendChild(option);
      }
    });

    if (codeSelect.options.length === 0) {
      const option = document.createElement("option");
      option.textContent = "❌ لا توجد رموز متوفرة";
      option.disabled = true;
      codeSelect.appendChild(option);
    }
  }

  productSelect.addEventListener("change", updateCodes);
  updateCodes();
</script>





 <script>
    function toggleSidebar() {
      const sidebar = document.getElementById('sidebar');
      const main = document.getElementById('main');
      sidebar.classList.toggle('active');
      main.classList.toggle('blur');
    }
  </script>




<script>

  function toggleChart(id) {
    const container = document.getElementById(id);
    const isHidden = container.style.display === 'none';

    // ✅ أظهر أو أخفِ القسم
    container.style.display = isHidden ? 'block' : 'none';

    // ✅ بعد الإظهار، أعد تهيئة الرسم البياني إن وُجد
    if (isHidden) {
      setTimeout(() => {
        const canvas = container.querySelector('canvas');
        if (canvas) {
          const chart = Chart.getChart(canvas);  // يحصل على الرسم البياني الحالي
          if (chart) {
            chart.resize();  // يعيد تهيئة الحجم
          } else {
            // في حال لم يتم تهيئة الرسم من قبل (احتياطيًا فقط)
            console.warn("⚠️ لا يوجد رسم بياني معرف لهذا العنصر:", canvas.id);
          }
        }
      }, 150); // تأخير بسيط لضمان أن العنصر أصبح ظاهرًا
    }
  }



 



  
    function showSection(id) {
      document.querySelectorAll('.admin-section').forEach(sec => sec.style.display = 'none');
      const target = document.getElementById(id);
      if (target) target.style.display = 'block';
    }

    // ✅ افتراضيًا أظهر "الرئيسية" فقط
    document.addEventListener("DOMContentLoaded", () => {
      showSection('section-home');
    });

    <!-- ✅ سكربت إظهار/إخفاء -->
function toggleForm() {
    const form = document.getElementById('add-key-form');
    form.style.display = (form.style.display === 'none') ? 'block' : 'none';
  }




</script>


v>
  </div>
</body>
</html>
